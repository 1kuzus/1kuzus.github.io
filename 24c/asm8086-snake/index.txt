2:I[55329,["481","static/chunks/457b8330-b5c9cf3fcf214847.js","954","static/chunks/d3ac728e-0c798b3b8aa3bf53.js","612","static/chunks/612-fa632c1349770315.js","120","static/chunks/120-aab2c7424ca78adb.js","842","static/chunks/842-812b9489b5c7f4d9.js","318","static/chunks/app/(posts)/%5B...slug%5D/page-c1d1ac841ab573d8.js"],""]
3:I[76842,["481","static/chunks/457b8330-b5c9cf3fcf214847.js","954","static/chunks/d3ac728e-0c798b3b8aa3bf53.js","612","static/chunks/612-fa632c1349770315.js","120","static/chunks/120-aab2c7424ca78adb.js","842","static/chunks/842-812b9489b5c7f4d9.js","318","static/chunks/app/(posts)/%5B...slug%5D/page-c1d1ac841ab573d8.js"],"PostMeta"]
4:"$Sreact.suspense"
6:I[76842,["481","static/chunks/457b8330-b5c9cf3fcf214847.js","954","static/chunks/d3ac728e-0c798b3b8aa3bf53.js","612","static/chunks/612-fa632c1349770315.js","120","static/chunks/120-aab2c7424ca78adb.js","842","static/chunks/842-812b9489b5c7f4d9.js","318","static/chunks/app/(posts)/%5B...slug%5D/page-c1d1ac841ab573d8.js"],"LikeButton"]
7:I[5613,[],""]
9:I[31778,[],""]
a:I[30389,["250","static/chunks/250-0ef8476c0fa8ee24.js","993","static/chunks/app/(posts)/layout-304e887950c7ad56.js"],""]
b:I[25694,["250","static/chunks/250-0ef8476c0fa8ee24.js","185","static/chunks/app/layout-adcd83bc3c8eff9d.js"],"GlobalProvider"]
c:I[30397,["250","static/chunks/250-0ef8476c0fa8ee24.js","185","static/chunks/app/layout-adcd83bc3c8eff9d.js"],""]
8:["slug","24c/asm8086-snake","c"]
0:["HcE5QpPzKp7mul4SlUGnb",[[["",{"children":["(posts)",{"children":[["slug","24c/asm8086-snake","c"],{"children":["__PAGE__?{\"slug\":[\"24c\",\"asm8086-snake\"]}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["(posts)",{"children":[["slug","24c/asm8086-snake","c"],{"children":["__PAGE__",{},["$L1",[["$","$L2",null,{}],false,["$","h1",null,{"className":"x-post-title","children":"8086汇编贪吃蛇"}],["$","$L3",null,{"path":"/24c/asm8086-snake/"}],["$","$4",null,{"fallback":["$","p",null,{"children":"Loading component..."}],"children":"$L5"}],["$","$L6",null,{"path":"/24c/asm8086-snake/"}]],null]]},["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children","$8","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/9abf08688ff29d0d.css","precedence":"next","crossOrigin":""}]]}]]},[null,["$","div",null,{"id":"post-layout","children":[["$","div",null,{"id":"main","className":"center-wrapper","children":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]}],["$","$La",null,{}]]}],null]]},[null,["$","html",null,{"lang":"zh-CN","suppressHydrationWarning":true,"children":[["$","head",null,{"children":[["$","link",null,{"rel":"icon","href":"/favicon.ico","type":"image/x-icon"}],["$","script",null,{"async":true,"src":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"}],["$","script",null,{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=G-45BYSZ6WPY"}],["$","script",null,{"dangerouslySetInnerHTML":{"__html":"\nwindow.dataLayer = window.dataLayer || [];\nfunction gtag() {\n    dataLayer.push(arguments);\n}\ngtag('js', new Date());\ngtag('config', 'G-45BYSZ6WPY');\n"}}],["$","script",null,{"dangerouslySetInnerHTML":{"__html":"const a=z=>h.getItem(z),b=(y,z)=>h.setItem(y,z),c=(y,z)=>document.documentElement.setAttribute(y,z),d='theme',e='dark',f='light',g='class',h=localStorage;a(d)!==e&&a(d)!==f&&b(d,f);a(d)===e?c(g,e):c(g,f);"}}],["$","script",null,{"dangerouslySetInnerHTML":{"__html":"\nif (!Array.prototype.findLast) {\n    Array.prototype.findLast = function (callback) {\n        for (let i = this.length - 1; i >= 0; i--) {\n            if (callback(this[i])) return this[i];\n        }\n        return undefined;\n    };\n}\nif (!Array.prototype.findLastIndex) {\n    Array.prototype.findLastIndex = function (callback) {\n        for (let i = this.length - 1; i >= 0; i--) {\n            if (callback(this[i])) return i;\n        }\n        return -1;\n    };\n}\n"}}]]}],["$","body",null,{"children":["$","$Lb",null,{"children":[["$","$Lc",null,{}],["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"id":"notfound","children":[["$","img",null,{"alt":"img","src":"/images/cry.gif"}],["$","code",null,{"id":"notfound-404","children":"404"}],["$","code",null,{"id":"notfound-text","children":"Page Not Found"}]]}],"notFoundStyles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/98e601cf5ba3633d.css","precedence":"next","crossOrigin":""}]],"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/3bc7e8f21884ab46.css","precedence":"next","crossOrigin":""}]]}]]}]}]]}],null]],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/cd6b648520195f61.css","precedence":"next","crossOrigin":""}]],"$Ld"]]]]
e:I[62029,["481","static/chunks/457b8330-b5c9cf3fcf214847.js","954","static/chunks/d3ac728e-0c798b3b8aa3bf53.js","612","static/chunks/612-fa632c1349770315.js","120","static/chunks/120-aab2c7424ca78adb.js","842","static/chunks/842-812b9489b5c7f4d9.js","318","static/chunks/app/(posts)/%5B...slug%5D/page-c1d1ac841ab573d8.js"],""]
18:I[74365,["481","static/chunks/457b8330-b5c9cf3fcf214847.js","954","static/chunks/d3ac728e-0c798b3b8aa3bf53.js","612","static/chunks/612-fa632c1349770315.js","120","static/chunks/120-aab2c7424ca78adb.js","842","static/chunks/842-812b9489b5c7f4d9.js","318","static/chunks/app/(posts)/%5B...slug%5D/page-c1d1ac841ab573d8.js"],""]
f:T5f3,datasg <span class="token keyword">segment</span>
    addri9 <span class="token keyword">db</span> <span class="token number">0,</span><span class="token number">0,</span><span class="token number">0,</span><span class="token number">0 </span>           <span class="token comment">;存放原9号中断的中断向量</span>
    seed   <span class="token keyword">db</span> <span class="token number">0adh </span>              <span class="token comment">;随机数种子</span>
    rand   <span class="token keyword">db</span> <span class="token number">0 </span>                 <span class="token comment">;随机数</span>
    apple  <span class="token keyword">db</span> <span class="token number">44h </span>               <span class="token comment">;果实位置，初始设为44h</span>
    dir    <span class="token keyword">db</span> <span class="token number">0 </span>                 <span class="token comment">;方向，0:up 1:right 2:left 3:down</span>
    dirbuf <span class="token keyword">db</span> <span class="token number">0
</span>    snake  <span class="token keyword">db</span> <span class="token number">4ah,</span><span class="token number">49h,</span><span class="token number">48h,</span><span class="token number">47h </span>   <span class="token comment">;蛇尾 --- 蛇头</span>
           <span class="token keyword">db</span> <span class="token number">256 </span><span class="token keyword">dup</span>(<span class="token number">0)</span>
datasg <span class="token keyword">ends</span>
10:T441,<span class="token comment">;;;;延迟一段时间</span>
delay:
          <span class="token function">push</span>  <span class="token register variable">cx</span>
          <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">7h </span>                           <span class="token comment">;增大此值可以减慢蛇的移动速度（间隔）</span>
d1:       <span class="token function">push</span>  <span class="token register variable">cx</span>
          <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">0ffffh
</span>d2:       <span class="token function">loop</span>  <span class="token number">d2
</span>          <span class="token function">pop</span>   <span class="token register variable">cx</span>
          <span class="token function">loop</span>  <span class="token number">d1
</span>          <span class="token function">pop</span>   <span class="token register variable">cx</span>
          <span class="token function">ret</span>
11:T669,<span class="token comment">;;;;平方取中随机数</span>
<span class="token comment">;输出：</span>
<span class="token comment">;rand     下一个随机数</span>
getrand:
          <span class="token function">push</span>  <span class="token register variable">ax</span>
          <span class="token function">push</span>  <span class="token register variable">cx</span>
          <span class="token function">mov</span>   <span class="token register variable">al</span>,rand
          <span class="token function">mul</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> rand
          <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token number">4
</span>          <span class="token function">shr</span>   <span class="token register variable">ax</span>,<span class="token register variable">cl</span>
          <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">0
</span>          <span class="token function">jnz</span>   ok
          <span class="token function">mov</span>   <span class="token register variable">al</span>,seed                          <span class="token comment">;避免陷入0循环</span>
ok:
          <span class="token function">mov</span>   rand,<span class="token register variable">al</span>
          <span class="token function">pop</span>   <span class="token register variable">cx</span>
          <span class="token function">pop</span>   <span class="token register variable">ax</span>
          <span class="token function">ret</span>
12:T843,codesg segment
    start:
             mov   ax,datasg
             mov   ds,ax
    ;保存原来9号中断的中断向量到addri9处
             mov   ax,0
             mov   es,ax
             push  es:[9*4]
             pop   word ptr addri9[0]
             push  es:[9*4+2]
             pop   word ptr addri9[2]
    ;更改原来的中断向量
             mov   word ptr es:[9*4],offset int9    ;设置9号中断的IP为offset int9
             mov   es:[9*4+2],cs                    ;设置9号中断的CS为代码段起始地址
             ;...

    ;游戏结束返回
    ret_main:
    ;恢复原来的中断向量
             mov   ax,0
             mov   es,ax
             push  word ptr addri9[0]
             pop   es:[9*4]
             push  word ptr addri9[2]
             pop   es:[9*4+2]
             ;...


    ;;;;自定义键盘中断
    int9:
             push  ax
             push  bx
    ;模拟标志寄存器入栈
             pushf
    ;模拟设置IF=0，TF=0
             pushf
             pop   ax
             and   ah,11111100b
             push  ax
             popf
    ;call指令即可实现CS、IP入栈并跳转到入口地址
             call  dword ptr addri9
    ;自定义的键盘输入处理
             in    al,60h                           ;读取键盘输入送入AL
             cmp   al,dir
             je    int9_dft
             cmp   al,11h                           ;W键
             je    int9_w
             cmp   al,20h                           ;D键
             je    int9_d
             cmp   al,1eh                           ;A键
             je    int9_a
             cmp   al,1fh                           ;S键
             je    int9_s
             jmp   int9_dft
    int9_w:
             mov   dirbuf,0
             jmp   int9_dft
    int9_d:
             mov   dirbuf,1
             jmp   int9_dft
    int9_a:
             mov   dirbuf,2
             jmp   int9_dft
    int9_s:
             mov   dirbuf,3
             jmp   int9_dft
    int9_dft:
             pop   bx
             pop   ax
             iret
codesg ends
end start
13:T1e24,codesg <span class="token keyword">segment</span>
    start:
             <span class="token function">mov</span>   <span class="token register variable">ax</span>,datasg
             <span class="token function">mov</span>   <span class="token register variable">ds</span>,<span class="token register variable">ax</span>
    <span class="token comment">;保存原来9号中断的中断向量到addri9处</span>
             <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">0
</span>             <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>
             <span class="token function">push</span>  <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>
             <span class="token function">pop</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">0]</span>
             <span class="token function">push</span>  <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>
             <span class="token function">pop</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">2]</span>
    <span class="token comment">;更改原来的中断向量</span>
             <span class="token function">mov</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>,<span class="token keyword">offset</span> int9    <span class="token comment">;设置9号中断的IP为offset int9</span>
             <span class="token function">mov</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>,<span class="token register variable">cs</span>                    <span class="token comment">;设置9号中断的CS为代码段起始地址</span>
             <span class="token comment">;...</span>

    <span class="token comment">;游戏结束返回</span>
    ret_main:
    <span class="token comment">;恢复原来的中断向量</span>
             <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">0
</span>             <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>
             <span class="token function">push</span>  <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">0]</span>
             <span class="token function">pop</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>
             <span class="token function">push</span>  <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">2]</span>
             <span class="token function">pop</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>
             <span class="token comment">;...</span>


    <span class="token comment">;;;;自定义键盘中断</span>
    int9:
             <span class="token function">push</span>  <span class="token register variable">ax</span>
             <span class="token function">push</span>  <span class="token register variable">bx</span>
    <span class="token comment">;模拟标志寄存器入栈</span>
             <span class="token function">pushf</span>
    <span class="token comment">;模拟设置IF=0，TF=0</span>
             <span class="token function">pushf</span>
             <span class="token function">pop</span>   <span class="token register variable">ax</span>
             <span class="token function">and</span>   <span class="token register variable">ah</span>,<span class="token number">11111100b
</span>             <span class="token function">push</span>  <span class="token register variable">ax</span>
             <span class="token function">popf</span>
    <span class="token comment">;call指令即可实现CS、IP入栈并跳转到入口地址</span>
             <span class="token function">call</span>  <span class="token keyword">dword</span> <span class="token keyword">ptr</span> addri9
    <span class="token comment">;自定义的键盘输入处理</span>
             <span class="token function">in</span>    <span class="token register variable">al</span>,<span class="token number">60h </span>                          <span class="token comment">;读取键盘输入送入AL</span>
             <span class="token function">cmp</span>   <span class="token register variable">al</span>,dir
             <span class="token function">je</span>    int9_dft
             <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">11h </span>                          <span class="token comment">;W键</span>
             <span class="token function">je</span>    int9_w
             <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">20h </span>                          <span class="token comment">;D键</span>
             <span class="token function">je</span>    int9_d
             <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">1eh </span>                          <span class="token comment">;A键</span>
             <span class="token function">je</span>    int9_a
             <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">1fh </span>                          <span class="token comment">;S键</span>
             <span class="token function">je</span>    int9_s
             <span class="token function">jmp</span>   int9_dft
    int9_w:
             <span class="token function">mov</span>   dirbuf,<span class="token number">0
</span>             <span class="token function">jmp</span>   int9_dft
    int9_d:
             <span class="token function">mov</span>   dirbuf,<span class="token number">1
</span>             <span class="token function">jmp</span>   int9_dft
    int9_a:
             <span class="token function">mov</span>   dirbuf,<span class="token number">2
</span>             <span class="token function">jmp</span>   int9_dft
    int9_s:
             <span class="token function">mov</span>   dirbuf,<span class="token number">3
</span>             <span class="token function">jmp</span>   int9_dft
    int9_dft:
             <span class="token function">pop</span>   <span class="token register variable">bx</span>
             <span class="token function">pop</span>   <span class="token register variable">ax</span>
             iret
codesg <span class="token keyword">ends</span>
<span class="token keyword">end</span> start
14:T8d6,游戏的地图大小设计为<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span>（含边界），这样刚好可以用<code class="x-inline-highlight">4</code>位表示一个坐标分量，一个字节表示一个二维坐标。约定一个字节的高<code class="x-inline-highlight">4</code>位表示<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>坐标，低<code class="x-inline-highlight">4</code>位表示<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>坐标。例如<code class="x-inline-highlight">4ah</code>表示逻辑坐标<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mclose">)</span></span></span></span>，对应<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span>地图中的第<code class="x-inline-highlight">10</code>行、第<code class="x-inline-highlight">4</code>列的方格。15:Td18,<span class="token comment">;;;;在显存[x+5行，2*y列]和[x+5行，2*y+1列]处写入属性BH（等价于逻辑坐标x,y）</span>
write:
<span class="token comment">;输入：</span>
<span class="token comment">;BH       属性</span>
<span class="token comment">;BL[7:4]  y坐标（逻辑列号）</span>
<span class="token comment">;BL[3:0]  x坐标（逻辑行号）</span>
          <span class="token function">push</span>  <span class="token register variable">cx</span>
          <span class="token function">mov</span>   <span class="token register variable">di</span>,<span class="token register variable">bx</span>
          <span class="token function">and</span>   <span class="token register variable">di</span>,<span class="token number">00f0h </span>                        <span class="token comment">;(di)=逻辑列号*16</span>
          <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token number">2
</span>          <span class="token function">shr</span>   <span class="token register variable">di</span>,<span class="token register variable">cl</span>                            <span class="token comment">;逻辑右移2位，(di)=逻辑列号*4</span>
          <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token register variable">bl</span>
          <span class="token function">and</span>   <span class="token register variable">cl</span>,<span class="token number">0fh </span>                          <span class="token comment">;(cl)=逻辑行号</span>
          <span class="token function">mov</span>   <span class="token register variable">al</span>,<span class="token number">10
</span>          <span class="token function">mul</span>   <span class="token register variable">cl</span>                               <span class="token comment">;(ax)=逻辑行号*10</span>
          <span class="token function">add</span>   <span class="token register variable">ax</span>,<span class="token number">0b800h+</span><span class="token number">50 </span>                    <span class="token comment">;(ax)=逻辑行号*10+b800h+50</span>
          <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>                            <span class="token comment">;(es)=逻辑行号*10+b800h+50</span>
          <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">di</span><span class="token operator">+</span><span class="token number">1]</span>,<span class="token register variable">bh</span>
          <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">di</span><span class="token operator">+</span><span class="token number">3]</span>,<span class="token register variable">bh</span>
          <span class="token function">pop</span>   <span class="token register variable">cx</span>
          <span class="token function">ret</span>
16:T249d,assume cs:codesg,ds:datasg,ss:stcksg

datasg segment
    addri9 db 0,0,0,0            ;存放原9号中断的中断向量
    seed   db 0adh               ;随机数种子
    rand   db 0                  ;随机数
    apple  db 44h                ;果实位置，初始设为44h
    dir    db 0                  ;方向，0:up 1:right 2:left 3:down
    dirbuf db 0
    snake  db 4ah,49h,48h,47h    ;蛇尾 --- 蛇头
           db 256 dup(0)
datasg ends

stcksg segment
           db 128 dup(0)
stcksg ends

codesg segment
    start:
              mov   ax,datasg
              mov   ds,ax
    ;保存原来9号中断的中断向量到addri9处
              mov   ax,0
              mov   es,ax
              push  es:[9*4]
              pop   word ptr addri9[0]
              push  es:[9*4+2]
              pop   word ptr addri9[2]
    ;更改原来的中断向量
              mov   word ptr es:[9*4],offset int9    ;设置9号中断的IP为offset int9
              mov   es:[9*4+2],cs                    ;设置9号中断的CS为代码段起始地址
    ;初始化
              call  init
    ;主循环
    main_loop:
              call  delay
              mov   al,dirbuf
              xor   al,dir
              cmp   al,3
              je    keep_dir
              xor   al,dir
              mov   dir,al
    keep_dir:
              call  move
              jmp   main_loop
    ;游戏结束返回
    gameover:
    ;恢复原来的中断向量
              mov   ax,0
              mov   es,ax
              push  word ptr addri9[0]
              pop   es:[9*4]
              push  word ptr addri9[2]
              pop   es:[9*4+2]
    ;清空键盘缓冲区
    clear:
              mov   ah, 01h
              int   16h
              je    done
              mov   ah, 00h
              int   16h
              jmp   clear
    done:
              mov   ax,4c00h
              int   21h

    ;;;;延迟一段时间
    delay:
              push  cx
              mov   cx,7h                            ;增大此值可以减慢蛇的移动速度（间隔）
    d1:       push  cx
              mov   cx,0ffffh
    d2:       loop  d2
              pop   cx
              loop  d1
              pop   cx
              ret

    ;;;;平方取中随机数
    ;输出：
    ;rand     下一个随机数
    getrand:
              push  ax
              push  cx
              mov   al,rand
              mul   byte ptr rand
              mov   cl,4
              shr   ax,cl
              cmp   al,0
              jnz   ok
              mov   al,seed                          ;避免陷入0循环
    ok:
              mov   rand,al
              pop   cx
              pop   ax
              ret

    ;;;;在显存[x+5行，2*y列]和[x+5行，2*y+1列]处写入属性BH（等价于逻辑坐标x,y）
    write:
    ;输入：
    ;BH       属性
    ;BL[7:4]  y坐标（逻辑列号）
    ;BL[3:0]  x坐标（逻辑行号）
              push  cx
              mov   di,bx
              and   di,00f0h                         ;(di)=逻辑列号*16
              mov   cl,2
              shr   di,cl                            ;逻辑右移2位，(di)=逻辑列号*4
              mov   cl,bl
              and   cl,0fh                           ;(cl)=逻辑行号
              mov   al,10
              mul   cl                               ;(ax)=逻辑行号*10
              add   ax,0b800h+50                     ;(ax)=逻辑行号*10+b800h+50
              mov   es,ax                            ;(es)=逻辑行号*10+b800h+50
              mov   byte ptr es:[di+1],bh
              mov   byte ptr es:[di+3],bh
              pop   cx
              ret

    ;;;;初始化地图
    init:
    ;清屏
              mov   ax,0b800h+50
              mov   es,ax
              mov   cx,7fffh
              mov   di,0
    i1:       mov   byte ptr es:[di],0
              inc   di
              loop  i1
    ;绘制果实和蛇
              call  getrand
              mov   bh,40h                           ;红底（果实）
              mov   bl,apple
              call  write
              mov   si,0
              mov   bh,20h                           ;绿底（蛇）
    i2:       mov   bl,snake[si]
              call  write
              inc   si
              cmp   byte ptr snake[si],0
              jnz   i2
    ;绘制边界
              mov   bh,70h                           ;白底（边界）
              mov   cx,15                            ;16*16地图（包含边界）
    i3:       mov   bl,cl                            ;x=i，y=0
              call  write
              or    bl,0f0h                          ;x=i，y=15
              call  write
              mov   bl,cl
              push  cx
              mov   cx,4
              shl   bl,cl                            ;赋值y=i
              pop   cx
              or    bl,0fh                           ;x=15，y=i
              call  write
              and   bl,0f0h                          ;x=0，y=i
              call  write
              jcxz  ret_init
              sub   cx,1
              jmp   i3
    ret_init:
              ret

    ;;;;移动一步
    move:
    ;si移动到头部下一个位置
              mov   si,0
    m2:       inc   si
              cmp   snake[si],0
              jnz   m2
    ;复制原头部数据
              mov   al,snake[si-1]
              mov   snake[si],al
    ;根据方向移动蛇头
              cmp   byte ptr dir,0
              je    move_u
              cmp   byte ptr dir,1
              je    move_r
              cmp   byte ptr dir,2
              je    move_l
              cmp   byte ptr dir,3
              je    move_d
              jmp   move_dft
    move_u:
              sub   snake[si],1
              jmp   move_dft
    move_r:
              add   snake[si],10h
              jmp   move_dft
    move_l:
              sub   snake[si],10h
              jmp   move_dft
    move_d:
              add   snake[si],1
              jmp   move_dft
    move_dft:
    ;擦除尾部
              mov   bh,0
              mov   bl,snake[0]
              call  write
    ;绘制新头部
              mov   bh,20h
              mov   bl,snake[si]
              call  write
    ;判定蛇头吃到果实或撞墙
              cmp   bl,apple
              je    eat
              call  is_valid
              cmp   al,0
              je    gameover
    ;移动蛇身
              mov   si,0
    m1:       mov   al,snake[si+1]
              mov   snake[si],al
              inc   si
              cmp   byte ptr snake[si+1],0
              jnz   m1
    ;擦除复制的新头部
              mov   snake[si],0
              jmp   ret_move
    ;吃到果实
    eat:
              mov   al,apple
              mov   snake[si],al
    m3:       call  getrand
              mov   bl,rand
              call  is_valid
              cmp   al,1
              jne   m3                               ;如果生成的位置已经有蛇身，则重新生成
              mov   byte ptr apple,bl
              mov   bh,40h
              mov   bl,apple
              call  write
              ret

    ;;;;判断合法位置：边界、蛇身处判定为不合法（不判断蛇头）
    is_valid:
    ;输入：
    ;BL     坐标
    ;输出：
    ;AL     0(不合法)/1(合法)
              push  bx
              mov   al,0
              cmp   bl,0fh                           ;x=i，y=0
              jb    false
              cmp   bl,0f0h                          ;x=i，y=15
              ja    false
              mov   bh,bl
              and   bh,0fh
              cmp   bh,0fh                           ;x=15，y=i
              je    false
              cmp   bh,0                             ;x=0，y=i
              je    false

              mov   si,0
    v1:       cmp   bl,snake[si]
              je    false
              inc   si
              cmp   byte ptr snake[si+1],0
              jnz   v1

              mov   al,1
    false:
              pop   bx
              ret

    ;;;;自定义键盘中断
    int9:
              push  ax
              push  bx
    ;模拟标志寄存器入栈
              pushf
    ;模拟设置IF=0，TF=0
              pushf
              pop   ax
              and   ah,11111100b
              push  ax
              popf
    ;call指令即可实现CS、IP入栈并跳转到入口地址
              call  dword ptr addri9
    ;自定义的键盘输入处理
              in    al,60h                           ;读取键盘输入送入AL
              cmp   al,dir
              je    int9_dft
              cmp   al,11h                           ;W键
              je    int9_w
              cmp   al,20h                           ;D键
              je    int9_d
              cmp   al,1eh                           ;A键
              je    int9_a
              cmp   al,1fh                           ;S键
              je    int9_s
              jmp   int9_dft
    int9_w:
              mov   dirbuf,0
              jmp   int9_dft
    int9_d:
              mov   dirbuf,1
              jmp   int9_dft
    int9_a:
              mov   dirbuf,2
              jmp   int9_dft
    int9_s:
              mov   dirbuf,3
              jmp   int9_dft
    int9_dft:
              pop   bx
              pop   ax
              iret
codesg ends
end start
17:T8750,<span class="token keyword">assume</span> <span class="token register variable">cs</span>:codesg,<span class="token register variable">ds</span>:datasg,<span class="token register variable">ss</span>:stcksg

datasg <span class="token keyword">segment</span>
    addri9 <span class="token keyword">db</span> <span class="token number">0,</span><span class="token number">0,</span><span class="token number">0,</span><span class="token number">0 </span>           <span class="token comment">;存放原9号中断的中断向量</span>
    seed   <span class="token keyword">db</span> <span class="token number">0adh </span>              <span class="token comment">;随机数种子</span>
    rand   <span class="token keyword">db</span> <span class="token number">0 </span>                 <span class="token comment">;随机数</span>
    apple  <span class="token keyword">db</span> <span class="token number">44h </span>               <span class="token comment">;果实位置，初始设为44h</span>
    dir    <span class="token keyword">db</span> <span class="token number">0 </span>                 <span class="token comment">;方向，0:up 1:right 2:left 3:down</span>
    dirbuf <span class="token keyword">db</span> <span class="token number">0
</span>    snake  <span class="token keyword">db</span> <span class="token number">4ah,</span><span class="token number">49h,</span><span class="token number">48h,</span><span class="token number">47h </span>   <span class="token comment">;蛇尾 --- 蛇头</span>
           <span class="token keyword">db</span> <span class="token number">256 </span><span class="token keyword">dup</span>(<span class="token number">0)</span>
datasg <span class="token keyword">ends</span>

stcksg <span class="token keyword">segment</span>
           <span class="token keyword">db</span> <span class="token number">128 </span><span class="token keyword">dup</span>(<span class="token number">0)</span>
stcksg <span class="token keyword">ends</span>

codesg <span class="token keyword">segment</span>
    start:
              <span class="token function">mov</span>   <span class="token register variable">ax</span>,datasg
              <span class="token function">mov</span>   <span class="token register variable">ds</span>,<span class="token register variable">ax</span>
    <span class="token comment">;保存原来9号中断的中断向量到addri9处</span>
              <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">0
</span>              <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>
              <span class="token function">push</span>  <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>
              <span class="token function">pop</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">0]</span>
              <span class="token function">push</span>  <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>
              <span class="token function">pop</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">2]</span>
    <span class="token comment">;更改原来的中断向量</span>
              <span class="token function">mov</span>   <span class="token keyword">word</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>,<span class="token keyword">offset</span> int9    <span class="token comment">;设置9号中断的IP为offset int9</span>
              <span class="token function">mov</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>,<span class="token register variable">cs</span>                    <span class="token comment">;设置9号中断的CS为代码段起始地址</span>
    <span class="token comment">;初始化</span>
              <span class="token function">call</span>  init
    <span class="token comment">;主循环</span>
    main_loop:
              <span class="token function">call</span>  delay
              <span class="token function">mov</span>   <span class="token register variable">al</span>,dirbuf
              <span class="token function">xor</span>   <span class="token register variable">al</span>,dir
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">3
</span>              <span class="token function">je</span>    keep_dir
              <span class="token function">xor</span>   <span class="token register variable">al</span>,dir
              <span class="token function">mov</span>   dir,<span class="token register variable">al</span>
    keep_dir:
              <span class="token function">call</span>  move
              <span class="token function">jmp</span>   main_loop
    <span class="token comment">;游戏结束返回</span>
    gameover:
    <span class="token comment">;恢复原来的中断向量</span>
              <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">0
</span>              <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>
              <span class="token function">push</span>  <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">0]</span>
              <span class="token function">pop</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4]</span>
              <span class="token function">push</span>  <span class="token keyword">word</span> <span class="token keyword">ptr</span> addri9<span class="token operator">[</span><span class="token number">2]</span>
              <span class="token function">pop</span>   <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token number">9*</span><span class="token number">4+</span><span class="token number">2]</span>
    <span class="token comment">;清空键盘缓冲区</span>
    clear:
              <span class="token function">mov</span>   <span class="token register variable">ah</span>, <span class="token number">01h
</span>              <span class="token function">int</span>   <span class="token number">16h
</span>              <span class="token function">je</span>    done
              <span class="token function">mov</span>   <span class="token register variable">ah</span>, <span class="token number">00h
</span>              <span class="token function">int</span>   <span class="token number">16h
</span>              <span class="token function">jmp</span>   clear
    done:
              <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">4c00h
</span>              <span class="token function">int</span>   <span class="token number">21h
</span>
    <span class="token comment">;;;;延迟一段时间</span>
    delay:
              <span class="token function">push</span>  <span class="token register variable">cx</span>
              <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">7h </span>                           <span class="token comment">;增大此值可以减慢蛇的移动速度（间隔）</span>
    d1:       <span class="token function">push</span>  <span class="token register variable">cx</span>
              <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">0ffffh
</span>    d2:       <span class="token function">loop</span>  <span class="token number">d2
</span>              <span class="token function">pop</span>   <span class="token register variable">cx</span>
              <span class="token function">loop</span>  <span class="token number">d1
</span>              <span class="token function">pop</span>   <span class="token register variable">cx</span>
              <span class="token function">ret</span>

    <span class="token comment">;;;;平方取中随机数</span>
    <span class="token comment">;输出：</span>
    <span class="token comment">;rand     下一个随机数</span>
    getrand:
              <span class="token function">push</span>  <span class="token register variable">ax</span>
              <span class="token function">push</span>  <span class="token register variable">cx</span>
              <span class="token function">mov</span>   <span class="token register variable">al</span>,rand
              <span class="token function">mul</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> rand
              <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token number">4
</span>              <span class="token function">shr</span>   <span class="token register variable">ax</span>,<span class="token register variable">cl</span>
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">0
</span>              <span class="token function">jnz</span>   ok
              <span class="token function">mov</span>   <span class="token register variable">al</span>,seed                          <span class="token comment">;避免陷入0循环</span>
    ok:
              <span class="token function">mov</span>   rand,<span class="token register variable">al</span>
              <span class="token function">pop</span>   <span class="token register variable">cx</span>
              <span class="token function">pop</span>   <span class="token register variable">ax</span>
              <span class="token function">ret</span>

    <span class="token comment">;;;;在显存[x+5行，2*y列]和[x+5行，2*y+1列]处写入属性BH（等价于逻辑坐标x,y）</span>
    write:
    <span class="token comment">;输入：</span>
    <span class="token comment">;BH       属性</span>
    <span class="token comment">;BL[7:4]  y坐标（逻辑列号）</span>
    <span class="token comment">;BL[3:0]  x坐标（逻辑行号）</span>
              <span class="token function">push</span>  <span class="token register variable">cx</span>
              <span class="token function">mov</span>   <span class="token register variable">di</span>,<span class="token register variable">bx</span>
              <span class="token function">and</span>   <span class="token register variable">di</span>,<span class="token number">00f0h </span>                        <span class="token comment">;(di)=逻辑列号*16</span>
              <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token number">2
</span>              <span class="token function">shr</span>   <span class="token register variable">di</span>,<span class="token register variable">cl</span>                            <span class="token comment">;逻辑右移2位，(di)=逻辑列号*4</span>
              <span class="token function">mov</span>   <span class="token register variable">cl</span>,<span class="token register variable">bl</span>
              <span class="token function">and</span>   <span class="token register variable">cl</span>,<span class="token number">0fh </span>                          <span class="token comment">;(cl)=逻辑行号</span>
              <span class="token function">mov</span>   <span class="token register variable">al</span>,<span class="token number">10
</span>              <span class="token function">mul</span>   <span class="token register variable">cl</span>                               <span class="token comment">;(ax)=逻辑行号*10</span>
              <span class="token function">add</span>   <span class="token register variable">ax</span>,<span class="token number">0b800h+</span><span class="token number">50 </span>                    <span class="token comment">;(ax)=逻辑行号*10+b800h+50</span>
              <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>                            <span class="token comment">;(es)=逻辑行号*10+b800h+50</span>
              <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">di</span><span class="token operator">+</span><span class="token number">1]</span>,<span class="token register variable">bh</span>
              <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">di</span><span class="token operator">+</span><span class="token number">3]</span>,<span class="token register variable">bh</span>
              <span class="token function">pop</span>   <span class="token register variable">cx</span>
              <span class="token function">ret</span>

    <span class="token comment">;;;;初始化地图</span>
    init:
    <span class="token comment">;清屏</span>
              <span class="token function">mov</span>   <span class="token register variable">ax</span>,<span class="token number">0b800h+</span><span class="token number">50
</span>              <span class="token function">mov</span>   <span class="token register variable">es</span>,<span class="token register variable">ax</span>
              <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">7fffh
</span>              <span class="token function">mov</span>   <span class="token register variable">di</span>,<span class="token number">0
</span>    i1:       <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">di</span><span class="token operator">]</span>,<span class="token number">0
</span>              <span class="token function">inc</span>   <span class="token register variable">di</span>
              <span class="token function">loop</span>  i1
    <span class="token comment">;绘制果实和蛇</span>
              <span class="token function">call</span>  getrand
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">40h </span>                          <span class="token comment">;红底（果实）</span>
              <span class="token function">mov</span>   <span class="token register variable">bl</span>,apple
              <span class="token function">call</span>  write
              <span class="token function">mov</span>   <span class="token register variable">si</span>,<span class="token number">0
</span>              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">20h </span>                          <span class="token comment">;绿底（蛇）</span>
    i2:       <span class="token function">mov</span>   <span class="token register variable">bl</span>,snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>
              <span class="token function">call</span>  write
              <span class="token function">inc</span>   <span class="token register variable">si</span>
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">0
</span>              <span class="token function">jnz</span>   i2
    <span class="token comment">;绘制边界</span>
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">70h </span>                          <span class="token comment">;白底（边界）</span>
              <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">15 </span>                           <span class="token comment">;16*16地图（包含边界）</span>
    i3:       <span class="token function">mov</span>   <span class="token register variable">bl</span>,<span class="token register variable">cl</span>                            <span class="token comment">;x=i，y=0</span>
              <span class="token function">call</span>  write
              <span class="token function">or</span>    <span class="token register variable">bl</span>,<span class="token number">0f0h </span>                         <span class="token comment">;x=i，y=15</span>
              <span class="token function">call</span>  write
              <span class="token function">mov</span>   <span class="token register variable">bl</span>,<span class="token register variable">cl</span>
              <span class="token function">push</span>  <span class="token register variable">cx</span>
              <span class="token function">mov</span>   <span class="token register variable">cx</span>,<span class="token number">4
</span>              <span class="token function">shl</span>   <span class="token register variable">bl</span>,<span class="token register variable">cl</span>                            <span class="token comment">;赋值y=i</span>
              <span class="token function">pop</span>   <span class="token register variable">cx</span>
              <span class="token function">or</span>    <span class="token register variable">bl</span>,<span class="token number">0fh </span>                          <span class="token comment">;x=15，y=i</span>
              <span class="token function">call</span>  write
              <span class="token function">and</span>   <span class="token register variable">bl</span>,<span class="token number">0f0h </span>                         <span class="token comment">;x=0，y=i</span>
              <span class="token function">call</span>  write
              <span class="token function">jcxz</span>  ret_init
              <span class="token function">sub</span>   <span class="token register variable">cx</span>,<span class="token number">1
</span>              <span class="token function">jmp</span>   i3
    ret_init:
              <span class="token function">ret</span>

    <span class="token comment">;;;;移动一步</span>
    move:
    <span class="token comment">;si移动到头部下一个位置</span>
              <span class="token function">mov</span>   <span class="token register variable">si</span>,<span class="token number">0
</span>    m2:       <span class="token function">inc</span>   <span class="token register variable">si</span>
              <span class="token function">cmp</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">0
</span>              <span class="token function">jnz</span>   m2
    <span class="token comment">;复制原头部数据</span>
              <span class="token function">mov</span>   <span class="token register variable">al</span>,snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">-</span><span class="token number">1]</span>
              <span class="token function">mov</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token register variable">al</span>
    <span class="token comment">;根据方向移动蛇头</span>
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> dir,<span class="token number">0
</span>              <span class="token function">je</span>    move_u
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> dir,<span class="token number">1
</span>              <span class="token function">je</span>    move_r
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> dir,<span class="token number">2
</span>              <span class="token function">je</span>    move_l
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> dir,<span class="token number">3
</span>              <span class="token function">je</span>    move_d
              <span class="token function">jmp</span>   move_dft
    move_u:
              <span class="token function">sub</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">1
</span>              <span class="token function">jmp</span>   move_dft
    move_r:
              <span class="token function">add</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">10h
</span>              <span class="token function">jmp</span>   move_dft
    move_l:
              <span class="token function">sub</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">10h
</span>              <span class="token function">jmp</span>   move_dft
    move_d:
              <span class="token function">add</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">1
</span>              <span class="token function">jmp</span>   move_dft
    move_dft:
    <span class="token comment">;擦除尾部</span>
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">0
</span>              <span class="token function">mov</span>   <span class="token register variable">bl</span>,snake<span class="token operator">[</span><span class="token number">0]</span>
              <span class="token function">call</span>  write
    <span class="token comment">;绘制新头部</span>
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">20h
</span>              <span class="token function">mov</span>   <span class="token register variable">bl</span>,snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>
              <span class="token function">call</span>  write
    <span class="token comment">;判定蛇头吃到果实或撞墙</span>
              <span class="token function">cmp</span>   <span class="token register variable">bl</span>,apple
              <span class="token function">je</span>    eat
              <span class="token function">call</span>  is_valid
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">0
</span>              <span class="token function">je</span>    gameover
    <span class="token comment">;移动蛇身</span>
              <span class="token function">mov</span>   <span class="token register variable">si</span>,<span class="token number">0
</span>    m1:       <span class="token function">mov</span>   <span class="token register variable">al</span>,snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">+</span><span class="token number">1]</span>
              <span class="token function">mov</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token register variable">al</span>
              <span class="token function">inc</span>   <span class="token register variable">si</span>
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">+</span><span class="token number">1]</span>,<span class="token number">0
</span>              <span class="token function">jnz</span>   m1
    <span class="token comment">;擦除复制的新头部</span>
              <span class="token function">mov</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token number">0
</span>              <span class="token function">jmp</span>   ret_move
    <span class="token comment">;吃到果实</span>
    eat:
              <span class="token function">mov</span>   <span class="token register variable">al</span>,apple
              <span class="token function">mov</span>   snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>,<span class="token register variable">al</span>
    m3:       <span class="token function">call</span>  getrand
              <span class="token function">mov</span>   <span class="token register variable">bl</span>,rand
              <span class="token function">call</span>  is_valid
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">1
</span>              jne   m3                               <span class="token comment">;如果生成的位置已经有蛇身，则重新生成</span>
              <span class="token function">mov</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> apple,<span class="token register variable">bl</span>
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token number">40h
</span>              <span class="token function">mov</span>   <span class="token register variable">bl</span>,apple
              <span class="token function">call</span>  write
              <span class="token function">ret</span>

    <span class="token comment">;;;;判断合法位置：边界、蛇身处判定为不合法（不判断蛇头）</span>
    is_valid:
    <span class="token comment">;输入：</span>
    <span class="token comment">;BL     坐标</span>
    <span class="token comment">;输出：</span>
    <span class="token comment">;AL     0(不合法)/1(合法)</span>
              <span class="token function">push</span>  <span class="token register variable">bx</span>
              <span class="token function">mov</span>   <span class="token register variable">al</span>,<span class="token number">0
</span>              <span class="token function">cmp</span>   <span class="token register variable">bl</span>,<span class="token number">0fh </span>                          <span class="token comment">;x=i，y=0</span>
              <span class="token function">jb</span>    false
              <span class="token function">cmp</span>   <span class="token register variable">bl</span>,<span class="token number">0f0h </span>                         <span class="token comment">;x=i，y=15</span>
              <span class="token function">ja</span>    false
              <span class="token function">mov</span>   <span class="token register variable">bh</span>,<span class="token register variable">bl</span>
              <span class="token function">and</span>   <span class="token register variable">bh</span>,<span class="token number">0fh
</span>              <span class="token function">cmp</span>   <span class="token register variable">bh</span>,<span class="token number">0fh </span>                          <span class="token comment">;x=15，y=i</span>
              <span class="token function">je</span>    false
              <span class="token function">cmp</span>   <span class="token register variable">bh</span>,<span class="token number">0 </span>                            <span class="token comment">;x=0，y=i</span>
              <span class="token function">je</span>    false

              <span class="token function">mov</span>   <span class="token register variable">si</span>,<span class="token number">0
</span>    v1:       <span class="token function">cmp</span>   <span class="token register variable">bl</span>,snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">]</span>
              <span class="token function">je</span>    false
              <span class="token function">inc</span>   <span class="token register variable">si</span>
              <span class="token function">cmp</span>   <span class="token keyword">byte</span> <span class="token keyword">ptr</span> snake<span class="token operator">[</span><span class="token register variable">si</span><span class="token operator">+</span><span class="token number">1]</span>,<span class="token number">0
</span>              <span class="token function">jnz</span>   v1

              <span class="token function">mov</span>   <span class="token register variable">al</span>,<span class="token number">1
</span>    false:
              <span class="token function">pop</span>   <span class="token register variable">bx</span>
              <span class="token function">ret</span>

    <span class="token comment">;;;;自定义键盘中断</span>
    int9:
              <span class="token function">push</span>  <span class="token register variable">ax</span>
              <span class="token function">push</span>  <span class="token register variable">bx</span>
    <span class="token comment">;模拟标志寄存器入栈</span>
              <span class="token function">pushf</span>
    <span class="token comment">;模拟设置IF=0，TF=0</span>
              <span class="token function">pushf</span>
              <span class="token function">pop</span>   <span class="token register variable">ax</span>
              <span class="token function">and</span>   <span class="token register variable">ah</span>,<span class="token number">11111100b
</span>              <span class="token function">push</span>  <span class="token register variable">ax</span>
              <span class="token function">popf</span>
    <span class="token comment">;call指令即可实现CS、IP入栈并跳转到入口地址</span>
              <span class="token function">call</span>  <span class="token keyword">dword</span> <span class="token keyword">ptr</span> addri9
    <span class="token comment">;自定义的键盘输入处理</span>
              <span class="token function">in</span>    <span class="token register variable">al</span>,<span class="token number">60h </span>                          <span class="token comment">;读取键盘输入送入AL</span>
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,dir
              <span class="token function">je</span>    int9_dft
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">11h </span>                          <span class="token comment">;W键</span>
              <span class="token function">je</span>    int9_w
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">20h </span>                          <span class="token comment">;D键</span>
              <span class="token function">je</span>    int9_d
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">1eh </span>                          <span class="token comment">;A键</span>
              <span class="token function">je</span>    int9_a
              <span class="token function">cmp</span>   <span class="token register variable">al</span>,<span class="token number">1fh </span>                          <span class="token comment">;S键</span>
              <span class="token function">je</span>    int9_s
              <span class="token function">jmp</span>   int9_dft
    int9_w:
              <span class="token function">mov</span>   dirbuf,<span class="token number">0
</span>              <span class="token function">jmp</span>   int9_dft
    int9_d:
              <span class="token function">mov</span>   dirbuf,<span class="token number">1
</span>              <span class="token function">jmp</span>   int9_dft
    int9_a:
              <span class="token function">mov</span>   dirbuf,<span class="token number">2
</span>              <span class="token function">jmp</span>   int9_dft
    int9_s:
              <span class="token function">mov</span>   dirbuf,<span class="token number">3
</span>              <span class="token function">jmp</span>   int9_dft
    int9_dft:
              <span class="token function">pop</span>   <span class="token register variable">bx</span>
              <span class="token function">pop</span>   <span class="token register variable">ax</span>
              iret
codesg <span class="token keyword">ends</span>
<span class="token keyword">end</span> start
5:[["$","h2",null,{"className":"x-h1","children":"变量设置"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"在数据段中使用以下变量："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":"datasg segment\n    addri9 db 0,0,0,0            ;存放原9号中断的中断向量\n    seed   db 0adh               ;随机数种子\n    rand   db 0                  ;随机数\n    apple  db 44h                ;果实位置，初始设为44h\n    dir    db 0                  ;方向，0:up 1:right 2:left 3:down\n    dirbuf db 0\n    snake  db 4ah,49h,48h,47h    ;蛇尾 --- 蛇头\n           db 256 dup(0)\ndatasg ends\n"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$f"}}]}]]}],["$","h2",null,{"className":"x-h1","children":"前置技术"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"在汇编实现贪吃蛇通常需要解决以下几个技术："}}],["$","h3",null,{"className":"x-h2","children":"延时函数"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"在汇编中延时函数可以通过执行空循环来实现："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":";;;;延迟一段时间\ndelay:\n          push  cx\n          mov   cx,7h                            ;增大此值可以减慢蛇的移动速度（间隔）\nd1:       push  cx\n          mov   cx,0ffffh\nd2:       loop  d2\n          pop   cx\n          loop  d1\n          pop   cx\n          ret\n"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$10"}}]}]]}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"虽然这种方法不能精确控制延迟多少秒/毫秒，但可以通过调节外层循环的次数（内层也可以）来相对地控制延迟时间。（一层循环最大执行次数是<code class=\"x-inline-highlight\">ffffh</code>，仍然太快，因此需要两层循环）"}}],["$","h3",null,{"className":"x-h2","children":"随机数"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"使用平方取中法实现一个简单的伪随机序列，随机种子预先写死在代码中："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":";;;;平方取中随机数\n;输出：\n;rand     下一个随机数\ngetrand:\n          push  ax\n          push  cx\n          mov   al,rand\n          mul   byte ptr rand\n          mov   cl,4\n          shr   ax,cl\n          cmp   al,0\n          jnz   ok\n          mov   al,seed                          ;避免陷入0循环\nok:\n          mov   rand,al\n          pop   cx\n          pop   ax\n          ret\n"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$11"}}]}]]}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"这里生成的是<code class=\"x-inline-highlight\">8</code>位的随机数，每次调用<code class=\"x-inline-highlight\">getrand</code>都会更新<code class=\"x-inline-highlight\">rand</code>标号处的一个字节的值。这个随机数生成方法有时会陷入<code class=\"x-inline-highlight\">0</code>循环，因此产生新的随机数时加了一个判断，如果结果为<code class=\"x-inline-highlight\">0</code>则重新从<code class=\"x-inline-highlight\">seed</code>开始生成。"}}],["$","h3",null,{"className":"x-h2","children":"处理键盘输入"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"使用自定义的键盘中断程序（<code class=\"x-inline-highlight\">9</code>号中断）解决，大致框架为："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":"$12"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$13"}}]}]]}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"在设计键盘响应时，不希望玩家能够直接修改蛇的移动方向为当前方向的反向（不能调转<span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6741em;\"></span><span class=\"mord\">18</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6741em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∘</span></span></span></span></span></span></span></span></span></span></span>），例如如果当前移动方向为向上，则应只允许修改为向左/向右，而不能修改为向下。为此额外添加了<code class=\"x-inline-highlight\">dirbuf</code>变量，用户的键盘输入会实时存入<code class=\"x-inline-highlight\">dirbuf</code>，但只在每次主循环中有条件地与<code class=\"x-inline-highlight\">dir</code>同步。主循环如下（其中<code class=\"x-inline-highlight\">move</code>函数处理蛇移动一步，后面会详细说明）："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":"main_loop:\n          call  delay\n          mov   al,dirbuf\n          xor   al,dir\n          cmp   al,3\n          je    keep_dir\n          xor   al,dir\n          mov   dir,al\nkeep_dir:\n          call  move\n          jmp   main_loop\n"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"main_loop:\n          <span class=\"token function\">call</span>  delay\n          <span class=\"token function\">mov</span>   <span class=\"token register variable\">al</span>,dirbuf\n          <span class=\"token function\">xor</span>   <span class=\"token register variable\">al</span>,dir\n          <span class=\"token function\">cmp</span>   <span class=\"token register variable\">al</span>,<span class=\"token number\">3\n</span>          <span class=\"token function\">je</span>    keep_dir\n          <span class=\"token function\">xor</span>   <span class=\"token register variable\">al</span>,dir\n          <span class=\"token function\">mov</span>   dir,<span class=\"token register variable\">al</span>\nkeep_dir:\n          <span class=\"token function\">call</span>  move\n          <span class=\"token function\">jmp</span>   main_loop\n"}}]}]]}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"代码中<code class=\"x-inline-highlight\">dir</code>与<code class=\"x-inline-highlight\">dirbuf</code>异或为<code class=\"x-inline-highlight\">3</code>时，表示方向刚好相差<span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6741em;\"></span><span class=\"mord\">18</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6741em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∘</span></span></span></span></span></span></span></span></span></span></span>，此时不改变<code class=\"x-inline-highlight\">dir</code>的值（<code class=\"x-inline-highlight\">je keep_dir</code>）；由于异或操作改变了<code class=\"x-inline-highlight\">AL</code>的值，因此送入<code class=\"x-inline-highlight\">dir</code>前需要再异或一次原来的<code class=\"x-inline-highlight\">dir</code>值。"}}],["$","h3",null,{"className":"x-h2","children":"坐标设计与操作显存绘制"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"通过操作显存绘制图形，显存中用<code class=\"x-inline-highlight\">2</code>个字节表示一个字符，低字节表示字符的ASCII码，高字节表示字符的颜色。这里不设置字符，只设置背景色，相邻的两列刚好凑成一个正方形。"}}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"$14"}}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"由于字符显示区是<code class=\"x-inline-highlight\">25</code>行、<code class=\"x-inline-highlight\">80</code>列，这里的<span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>坐标对应了<code class=\"x-inline-highlight\">行号-5</code>（为了让地图显示在屏幕中间），<span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>坐标对应了<code class=\"x-inline-highlight\">列号/2</code>（因为每个字符占<code class=\"x-inline-highlight\">2</code>列）。封装一个<code class=\"x-inline-highlight\">write</code>函数，用于将属性写入显存的指定位置："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":";;;;在显存[x+5行，2*y列]和[x+5行，2*y+1列]处写入属性BH（等价于逻辑坐标x,y）\nwrite:\n;输入：\n;BH       属性\n;BL[7:4]  y坐标（逻辑列号）\n;BL[3:0]  x坐标（逻辑行号）\n          push  cx\n          mov   di,bx\n          and   di,00f0h                         ;(di)=逻辑列号*16\n          mov   cl,2\n          shr   di,cl                            ;逻辑右移2位，(di)=逻辑列号*4\n          mov   cl,bl\n          and   cl,0fh                           ;(cl)=逻辑行号\n          mov   al,10\n          mul   cl                               ;(ax)=逻辑行号*10\n          add   ax,0b800h+50                     ;(ax)=逻辑行号*10+b800h+50\n          mov   es,ax                            ;(es)=逻辑行号*10+b800h+50\n          mov   byte ptr es:[di+1],bh\n          mov   byte ptr es:[di+3],bh\n          pop   cx\n          ret\n"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$15"}}]}]]}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"显存的起始地址是<code class=\"x-inline-highlight\">b8000h</code>，屏幕第<code class=\"x-inline-highlight\">i</code>行、第<code class=\"x-inline-highlight\">j</code>列的偏移地址是<code class=\"x-inline-highlight\">80&#42;2&#42;i+2&#42;j</code>，用<code class=\"x-inline-highlight\">段地址:偏移地址</code>表示为<code class=\"x-inline-highlight\">b800:80&#42;2&#42;i+2&#42;j</code>；我们希望从第<code class=\"x-inline-highlight\">5</code>行开始显示地图，因此偏移地址额外加上<code class=\"x-inline-highlight\">80&#42;2&#42;5</code>，如果加到段地址上还要除以<code class=\"x-inline-highlight\">16</code>，也就是<code class=\"x-inline-highlight\">80&#42;2&#42;5/16=50</code>，对应代码中<code class=\"x-inline-highlight\">0b800h+50</code>。"}}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"同理，逻辑行号在偏移地址中数值要乘<code class=\"x-inline-highlight\">80*2=160</code>，而表示在段地址中只需乘<code class=\"x-inline-highlight\">160/16=10</code>。"}}],["$","h2",null,{"className":"x-h1","children":"实现"}],["$","h3",null,{"className":"x-h2","children":"代码"}],["$","p",null,{"className":"x-p","dangerouslySetInnerHTML":{"__html":"完整的代码如下："}}],["$","div",null,{"className":"x-codeblock","children":[["$","div",null,{"className":"x-codeblock-header","children":[["$","div",null,{"className":"x-codeblock-header-language","children":"ASM8086"}],["$","$Le",null,{"className":"x-codeblock-header-copy","text":"$16"}]]}],["$","pre",null,{"style":{"background":null},"children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"$17"}}]}]]}],["$","h3",null,{"className":"x-h2","children":"演示"}],["$","$L18",null,{"src":"game.gif"}]]
d:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"8086汇编贪吃蛇 - 铃木的网络日记"}],["$","link","3",{"rel":"canonical","href":"https://1kuzus.github.io/24c/asm8086-snake/"}]]
1:null
